# Wrangler configuration for Container vs WASM Latency Benchmark Worker
#
# This worker compares latency characteristics between:
# - WASM databases running in-Worker
# - Containerized databases running in Cloudflare Containers
#
# Deploy: wrangler deploy -c worker/bench-container-latency.wrangler.toml

name = "bench-container-latency-v2"
account_id = "b6641681fe423910342b9ffa1364c76d"
main = "bench-container-latency.ts"
compatibility_date = "2025-01-21"
compatibility_flags = ["nodejs_compat"]

# ==============================================================================
# WASM Module Rules
# ==============================================================================
# These rules enable static import of WASM modules and data files.
# PGLite requires pre-compiled WASM for Cloudflare Workers compatibility.
# Without these rules, PGLite fails with "Invalid URL string" error.
# ==============================================================================

[[rules]]
type = "CompiledWasm"
globs = ["**/*.wasm"]

[[rules]]
type = "Data"
globs = ["**/*.data"]

# Enable logpush for benchmark analysis
logpush = true

# Worker limits
[limits]
cpu_ms = 30000  # 30 seconds for batch benchmarks

# Development settings
[dev]
port = 8787
local_protocol = "http"

# R2 bucket for storing benchmark results
[[r2_buckets]]
binding = "BENCHMARK_RESULTS"
bucket_name = "bench-results"
preview_bucket_name = "bench-results-preview"

# ==============================================================================
# Container Bindings
# ==============================================================================
# Each container runs a database with an HTTP bridge for communication.
# Containers support different size tiers affecting performance and cost.
#
# Size tiers:
# - lite:           256MB RAM, 0.25 vCPU ($0.015/hr)
# - basic:          512MB RAM, 0.5 vCPU ($0.03/hr)
# - standard-1:     1GB RAM, 1 vCPU ($0.06/hr)
# - standard-2:     2GB RAM, 2 vCPU ($0.12/hr)
# - standard-4:     4GB RAM, 4 vCPU ($0.24/hr)
# - performance-8:  8GB RAM, 8 vCPU ($0.48/hr)
# - performance-16: 16GB RAM, 16 vCPU ($0.96/hr)
# ==============================================================================

# PostgreSQL Container
[[containers]]
class_name = "PostgresBenchContainer"
image = "../containers/dockerfiles/Dockerfile.postgres"
instance_type = "standard-2"
max_instances = 2

# ClickHouse Container
[[containers]]
class_name = "ClickHouseBenchContainer"
image = "../containers/dockerfiles/Dockerfile.clickhouse"
instance_type = "standard-2"
max_instances = 2

# MongoDB Container
[[containers]]
class_name = "MongoBenchContainer"
image = "../containers/dockerfiles/Dockerfile.mongo"
instance_type = "standard-2"
max_instances = 2

# DuckDB Container
[[containers]]
class_name = "DuckDBBenchContainer"
image = "../containers/dockerfiles/Dockerfile.duckdb"
instance_type = "standard-1"
max_instances = 2

# SQLite Container
[[containers]]
class_name = "SQLiteBenchContainer"
image = "../containers/dockerfiles/Dockerfile.sqlite"
instance_type = "standard-1"
max_instances = 2

# ==============================================================================
# Durable Object Bindings
# ==============================================================================
# Durable Objects provide the interface for Worker-to-Container communication.
# ==============================================================================

[[durable_objects.bindings]]
name = "POSTGRES_DO"
class_name = "PostgresBenchContainer"

[[durable_objects.bindings]]
name = "CLICKHOUSE_DO"
class_name = "ClickHouseBenchContainer"

[[durable_objects.bindings]]
name = "MONGO_DO"
class_name = "MongoBenchContainer"

[[durable_objects.bindings]]
name = "DUCKDB_DO"
class_name = "DuckDBBenchContainer"

[[durable_objects.bindings]]
name = "SQLITE_DO"
class_name = "SQLiteBenchContainer"

# ==============================================================================
# Migrations
# ==============================================================================
# Containers require new_sqlite_classes for SQLite storage used by the
# Container runtime for state management.
# ==============================================================================

[[migrations]]
tag = "v1"
new_sqlite_classes = ["PostgresBenchContainer", "ClickHouseBenchContainer", "MongoBenchContainer", "DuckDBBenchContainer", "SQLiteBenchContainer"]

# ==============================================================================
# Environment-specific configurations
# ==============================================================================

# Production environment
[env.production]
name = "bench-container-latency-v2"
route = { pattern = "bench.dotdo.workers.dev/benchmark/container-latency*", zone_name = "dotdo.workers.dev" }

[[env.production.r2_buckets]]
binding = "BENCHMARK_RESULTS"
bucket_name = "bench-results-prod"

# Staging environment
[env.staging]
name = "bench-container-latency-staging"

[[env.staging.r2_buckets]]
binding = "BENCHMARK_RESULTS"
bucket_name = "bench-results-staging"

# ==============================================================================
# Observability
# ==============================================================================

[observability]
enabled = true

[observability.logs]
enabled = true
invocation_logs = true

# ==============================================================================
# Placement (optional - for specific region targeting)
# ==============================================================================

# Uncomment to pin to specific region for consistent benchmarking
# [placement]
# mode = "smart"
# hint = "iad"  # Ashburn, Virginia (US East)

# ==============================================================================
# Tail workers for real-time monitoring (optional)
# ==============================================================================

# [tail_consumers]
# - service = "bench-analytics"
