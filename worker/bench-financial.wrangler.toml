# Wrangler configuration for Financial Benchmark Worker
#
# This worker runs TigerBeetle financial benchmarks:
# - Account creation (single and batch)
# - Transfer processing throughput
# - Balance lookups
# - Two-phase transfers
#
# Deploy: wrangler deploy -c worker/bench-financial.wrangler.toml

name = "bench-financial"
main = "bench-financial.ts"
compatibility_date = "2025-01-21"
compatibility_flags = ["nodejs_compat"]

# Enable logpush for benchmark analysis
logpush = true

# Worker limits
[limits]
cpu_ms = 30000  # 30 seconds for batch benchmarks

# Development settings
[dev]
port = 8788
local_protocol = "http"

# ==============================================================================
# Durable Object Bindings
# ==============================================================================
# TigerBeetle Benchmark DO manages ledger state for financial benchmarks.
# Uses SQLite-backed persistent storage for the LedgerState.

[[durable_objects.bindings]]
name = "TIGERBEETLE_DO"
class_name = "TigerBeetleBenchDO"

# Durable Object migration for SQLite storage
[[migrations]]
tag = "v1"
new_sqlite_classes = ["TigerBeetleBenchDO"]

# ==============================================================================
# R2 Storage
# ==============================================================================
# Results bucket for storing benchmark output as JSONL

[[r2_buckets]]
binding = "RESULTS"
bucket_name = "bench-results"
preview_bucket_name = "bench-results-preview"

# ==============================================================================
# Environment Variables
# ==============================================================================

[vars]
ENVIRONMENT = "worker"
BENCHMARK_TYPE = "financial"

# ==============================================================================
# Environment-specific configurations
# ==============================================================================

# Production environment
[env.production]
name = "bench-financial"
route = { pattern = "bench.dotdo.workers.dev/benchmark/financial*", zone_name = "dotdo.workers.dev" }

[[env.production.r2_buckets]]
binding = "RESULTS"
bucket_name = "bench-results-prod"

# Staging environment
[env.staging]
name = "bench-financial-staging"

[[env.staging.r2_buckets]]
binding = "RESULTS"
bucket_name = "bench-results-staging"

# ==============================================================================
# Observability
# ==============================================================================

[observability]
enabled = true

[observability.logs]
enabled = true
invocation_logs = true

# ==============================================================================
# Build configuration
# ==============================================================================

[build]
command = ""

[build.upload]
format = "modules"
main = "./bench-financial.ts"

[[build.upload.rules]]
type = "ESModule"
globs = ["**/*.ts"]

# ==============================================================================
# Placement (optional - for specific region targeting)
# ==============================================================================

# Uncomment to pin to specific region for consistent benchmarking
# [placement]
# mode = "smart"
# hint = "iad"  # Ashburn, Virginia (US East)

# ==============================================================================
# Tail workers for real-time monitoring (optional)
# ==============================================================================

# [tail_consumers]
# - service = "bench-analytics"
